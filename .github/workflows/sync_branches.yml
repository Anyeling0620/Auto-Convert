name: Sync Main to All Branches

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.github/workflows/**'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git User
        run: |
          git config --global user.name "Sync-Bot"
          git config --global user.email "bot@factory.com"

      - name: Sync Main to Other Branches
        run: |
          # è·å–é™¤äº† main ä»¥å¤–çš„æ‰€æœ‰è¿œç¨‹åˆ†æ”¯
          branches=$(git branch -r | grep -v '\->' | grep -v 'origin/main' | sed 's/origin\///' | xargs)
          
          if [ -z "$branches" ]; then
            echo "âš ï¸ æœªå‘ç°å…¶ä»–åˆ†æ”¯ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi

          echo "æ£€æµ‹åˆ°ç›®æ ‡åˆ†æ”¯: $branches"

          for branch in $branches; do
            echo "=============================================="
            echo "ğŸš€ æ­£åœ¨åŒæ­¥: main -> $branch"
            
            git checkout $branch
            
            # 1. å°è¯•åˆå¹¶ main (ä¸è‡ªåŠ¨æäº¤ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¿®æ”¹æ–‡ä»¶)
            # --no-commit: ç»™æˆ‘ä»¬æœºä¼šå¤„ç†æ–‡ä»¶
            # --no-ff: ä¿æŒæäº¤å†å²æ¸…æ™°
            git merge origin/main --no-commit --no-ff || true
            
            echo "ğŸ›¡ï¸ æ‰§è¡Œã€æ•°æ®é˜²ç«å¢™ã€‘ç­–ç•¥..."

            # =======================================================
            # ç­–ç•¥ 1: ä¿æŠ¤ config.json
            # =======================================================
            # é€»è¾‘ï¼šå¼ºåˆ¶å°† config.json æ¢å¤æˆå½“å‰åˆ†æ”¯(HEAD)çš„ç‰ˆæœ¬
            if git rev-parse --verify HEAD:config.json >/dev/null 2>&1; then
                echo "   - æ¢å¤å½“å‰åˆ†æ”¯çš„ config.json"
                git checkout HEAD -- config.json
            else
                echo "   - å½“å‰åˆ†æ”¯æ—  config.jsonï¼Œä¿æŒåŸæ ·"
            fi
            
            # =======================================================
            # ç­–ç•¥ 2: ä¿æŠ¤ input/ å’Œ output/ (å®Œå…¨éš”ç¦»)
            # =======================================================
            # é€»è¾‘ï¼š
            # A. å…ˆæŠŠåˆå¹¶è¿›æ¥çš„ input/output å…¨éƒ¨ä»æš‚å­˜åŒºåˆ é™¤ (æ‹’ç» Main çš„æ•°æ®)
            #    è¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢ Main é‡Œæœ‰æ–°æ–‡ä»¶è¢«æ„å¤–åŠ è¿›æ¥
            git rm -rfq input output || true
            
            # B. å†ä»å½“å‰åˆ†æ”¯(HEAD) æ¢å¤åŸæœ¬çš„æ•°æ® (å¦‚æœæœ‰çš„è¯)
            #    è¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢ Main åˆ é™¤äº†æ–‡ä»¶å¯¼è‡´æˆ‘ä»¬ä¹Ÿä¸¢æ–‡ä»¶
            git checkout HEAD -- input output 2>/dev/null || true
            
            # C. ç¡®ä¿æ–‡ä»¶å¤¹ç»“æ„å­˜åœ¨ (å¦‚æœä¸å¤å­˜åœ¨ï¼Œåˆ™æ–°å»º)
            #    è¿™æ˜¯ä¸ºäº†æ»¡è¶³â€œå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºâ€çš„éœ€æ±‚
            mkdir -p input output
            
            # D. æ”¾å…¥ .gitkeep å ä½ç¬¦å¹¶è¿½è¸ªï¼Œé˜²æ­¢ç©ºæ–‡ä»¶å¤¹æ— æ³•æäº¤
            touch input/.gitkeep output/.gitkeep
            git add input/.gitkeep output/.gitkeep
            
            echo "   - æ•°æ®æ–‡ä»¶å¤¹å·²éš”ç¦»å¹¶é‡ç½®"
            # =======================================================

            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
            if git diff --cached --quiet; then
              echo "âœ… $branch å·²ç»æ˜¯æœ€æ–°ï¼Œæ— éœ€æäº¤ã€‚"
            else
              echo "ğŸ“ æäº¤æ›´æ”¹..."
              git commit -m "Sync: Update code from main (Data & Config Protected)"
              
              echo "â˜ï¸ æ¨é€ $branch ..."
              git push origin $branch
            fi
            
            echo "âœ… $branch å¤„ç†å®Œæ¯•"
          done